stages:
        - build
        - test

build-fedora:
        image: fedora:rawhide
        stage: build
        before_script:
                - dnf -y install
                                desktop-file-utils
                                gcc
                                gettext
                                git
                                glib2-devel
                                gnome-desktop3-devel
                                gnome-settings-daemon
                                gsettings-desktop-schemas
                                gtk4-devel
                                ibus-devel
                                mesa-libEGL-devel
                                mesa-libGL-devel
                                meson
                                mutter-devel
                                patchutils
                                uncrustify
        script:
                - export BUILD_ROOT=_build
                - meson . $BUILD_ROOT --prefix=/usr --sysconfdir=/etc --localstatedir=/var --mandir=/usr/share/man --libdir=/usr/lib64
                - ninja -C $BUILD_ROOT
                - ninja -C $BUILD_ROOT install
                - ninja -C $BUILD_ROOT dist
                - find -depth -type d -name '*.p' -exec rm -rf "{}" \;
        except:
                - tags
        artifacts:
                paths:
                        - _build
        only:
            - merge_requests

test-fedora:
        extends:
                - build-fedora
        stage: test
        script:
                - export BUILD_ROOT=_build
                - meson . $BUILD_ROOT --prefix=/usr --sysconfdir=/etc --localstatedir=/var --mandir=/usr/share/man --libdir=/usr/lib64
                - ninja -C $BUILD_ROOT
                - ninja -C $BUILD_ROOT test
                - find -depth -type d -name '*.p' -exec rm -rf "{}" \;
        artifacts:
                paths:
                        - _build
        only:
            - merge_requests
